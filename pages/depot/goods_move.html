<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../easyui/themes/default/easyui.css" />
		<link rel="stylesheet" type="text/css" href="../../easyui/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<script type="text/javascript" src="../../easyui/jquery.min.js"></script>
		<script type="text/javascript" src="../../easyui/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../../js/My97DatePicker/WdatePicker.js"></script>
		<script type="text/javascript" src="../../js/time.js"></script>
		<script>
			$(function() {
				initTableData();
			});

			//初始化表格
			function initTableData() {
				$('#tableData').datagrid({
					url: '',
					method: 'get',
					checkOnSelect: false,
					singleSelect: false,
					columns: [
						[{
								field: 'id',
								width: 35,
								align: "center",
								checkbox: true
							},
							{
								title: '操作',
								field: 'op',
								align: "center",
								width: 60,
								formatter: function(value, data) {
									var str = '';
									str += '<img title="详细" src="../../easyui/themes/icons/pencil.png" style="cursor: pointer;" onclick="editDepot(\'' + data.id + '\');';
									return str;
								}
							},
							{
								title: '单号',
								field: 'num',
								width: 70
							},
							{
								title: '存货仓库',
								field: 'address',
								width: 300
							},
							{
								title: '目标仓库',
								field: 'capacity',
								width: 80
							},
							{
								title: '商品信息',
								field: 'currCount',
								width: 80
							},
							{
								title: '总数量',
								field: 'manager',
								width: 80
							},
							{
								title: '时间',
								field: 'managerTel',
								width: 100
							},
							{
								title: '详细',
								field: 'remark',
								width: 800
							}
						]
					],
					toolbar: [{
							id: 'addDepot',
							text: '增加',
							iconCls: 'icon-add',
							handler: function() {
								$("#depotHeadDlg").dialog('open').dialog('setTitle', '<img src="../../easyui/themes/icons/edit_add.png"/>&nbsp;增加调拨信息');
								$("#Remark").val("");
								$("#sum").numberbox('setValue', 0);
								initGoodsTB();
								$('#materialData').datagrid('loadData',{total:0,rows:[]});
								getNewNum();
								initCombox("#curr_depot");
								initCombox("#to_depot");
								var operator = localStorage.getItem("name");
								$("#operator").val(operator);
							}
						},
						{
							id: 'deleteDepot',
							text: '删除',
							iconCls: 'icon-remove',
							handler: function() {

							}
						}
					],
					pagination: true,
					pageSize: 10,
					pageList: [5, 10, 20],
					onLoadError: function() {
						$.messager.alert('页面加载提示', '输入错误或系统错误，页面加载异常', 'error');
						return;
					}

				});

			}

			function initGoodsTB() {
				$("#create_time").val(today());
				$("#materialData").datagrid({
					height: 245,
					rownumbers: true,
					//动画效果
					animate: false,
					collapsible: false,
					selectOnCheck: false,
					pagination: false,
					//交替出现背景
					striped: true,
					showFooter: true,
					toolbar: [{
							id: 'addDepot',
							text: '增加',
							iconCls: 'icon-add',
							handler: function() {
								$("#addDlg").dialog('open').dialog('setTitle', '<img src="../../easyui/themes/icons/edit_add.png"/>&nbsp;增加商品信息');;
								getGoods();
								$("#curr_count").numberbox("setValue", 0);
								$("#tar_count").numberbox("setValue", 0);
								
							}
						},
						{
							id: 'deleteDepot',
							text: '删除',
							iconCls: 'icon-remove',
							handler: function() {
								var row = $('#materialData').datagrid('getChecked');
								if(row.length == 0) {
									alert("请选择");
									return;
								}
								if(row.length > 0) {	
									for(var i = 0; i < row.length; i++) {
										var index = $('#materialData').datagrid('getRowIndex', row[i]);
										alert(index);
										var index = $('#materialData').datagrid('deleteRow', index);
									}
								}
							}
						},
						{
							id: 'resetDepot',
							text: '重置',
							iconCls: 'icon-reload',
							handler: function() {
								$('#materialData').datagrid('loadData',{total:0,rows:[]});
							}
						}
					],
					columns: [
						[{
								field: 'id',
								width: 35,
								align: "center",
								checkbox: true
							},
							{
								title: '商品',
								field: 'name',
								width: 230
							},
							{
								title: '调拨数量',
								field: 'to_count',
								width: 80
							},
							{
								title: '单位',
								field: 'unit',
								width: 60
							}
						]
					],
					onLoadError: function() {
						$.messager.alert('页面加载提示', '页面加载异常，请稍后再试！', 'error');
						return;
					}
				});
			}

			function addGoods() {
				var name = $("#name").val();
				var to_count = $("#to_count").val();
				var unit = $("#unit").val();
				if(name == ""){
					alert("请选择商品");
					return;
				}
				if(to_count == 0){
					alert("请输入调拨的数量");
					return;
				}
				$("#materialData").datagrid('appendRow', {
					name: name,
					to_count: to_count,
					unit: unit
				});
				close_addFM();
				var rows = $("#materialData").datagrid('getRows');
				var sum = 0;
				for(var i = 0; i < rows.length; i++){
					sum = sum + Number(rows[i].to_count);
					
				}
				$("#sum").numberbox('setValue', sum);
			}

			function close_addFM() {
				$("#name").val("");
				$("#to_count").numberbox('setValue', 0);
				$("#unit").val("");
				$("#curr_count").val("");
				$("#tar_count").val("");
				$("#addDlg").dialog('close');
			}
			
			function getNewNum(){
				var num;
				$.ajax({
					type:"get",
					url:"http://localhost:8001/allocation-info/getNewNum",
					xhrFields: {withCredentials:true},
					success: function(data){
						if(data.code == 200){
							$("#new_num").val(data.data);
						}else{
							alert("获取新单号失败!");
						}
					},
					error: function(){
						alert("系统错误!");
					}
				});
				
			}
			
			function getGoods(){
				var depotNum = $("#curr_depot").val();
				$("#name").combobox({
					method: "get",
					url: "http://localhost:8001/depot-goods/getDepotGoodsByDnum?depotNum=" + depotNum,
					textField: "goodsName",
					valueField: "goodsName",
					onSelect: function(pa){
						var good = pa.goodsName;
						var curr_d = $("#curr_depot").val();
						var to_d = $("#to_depot").val();
						setCount(curr_d, good, 1);
						setCount(to_d, good, 2);
					}
				});
			}
			
			function setCount(dnum, goods, we){
				$.ajax({
					type:"get",
					dataType: "json",
					url:"http://localhost:8001/depot-goods/getCountsByDnumAndGoods?depotNum=" + dnum + "&goodsName=" + goods,
					xhrFields: {withCredentials:true},
					success: function(data){
						if(data.code == 200){
							if(we == 1){
//								$("#curr_count").val(data.data.count);
								$("#curr_count").numberbox("setValue", data.data.count);
								$("#unit").val(data.data.unit);
							}
							if(we == 2){
								if(data.data == null){
									$("#tar_count").numberbox("setValue", 0);
								}else{
									$("#tar_count").numberbox("setValue", data.data.count);
								}
								
							}
						}
					},
					error: function(){
						alert("系统错误!");
					}
				});
			}
			
			
			function initCombox(it){
				$(it).combobox({
					method: "get",
					url: "http://localhost:8001/depot/getDepot",
					textField: "num",
					valueField: "num",
					onSelect: function(){
						$('#materialData').datagrid('loadData',{total:0,rows:[]});
						$("#sum").numberbox('setValue', 0);
					}
					
				});
			}
			
			function sendSava(){
				var create_time = $("#create_time").val();
				var new_num = $("#new_num").val();
				var curr_depot = $("#curr_depot").val();
				var to_depot = $("#to_depot").val();
				var sum = $("#sum").numberbox('getValue');
				var operator = $("#operator").val();
				var Remark = $("#Remark").val();
				var goods = "";
				var rows = $("#materialData").datagrid('getRows');
				if(operator == ""){
					alert("获取操作者失败，请重新登陆");
					top.location.href="login.html";
					return;
				}
				if(curr_depot == "" || to_depot == ""){
					alert("请选择仓库");
					return;
				}
				if(curr_depot == to_depot){
					alert("请选择出入库仓库");
					return;
				}
				if(rows.length == 0){
					alert("请添加需要调拨的商品");
					return;
				}
				for(var i = 0; i < rows.length; i++){
					goods += rows[i].name;
					goods += ":";
					goods += rows[i].to_count;
					goods += ":";
					goods += rows[i].unit;
					goods += ";";
				}
//				alert(create_time + " " + new_num + " " +curr_depot + " " +to_depot +
//				" " +sum + " " +operator + " " +Remark + " " +goods);
				$.ajax({
					type:"get",
					url:"http://localhost:8001/allocation-info/insert",
					xhrFields: {withCredentials:true},
					dataType: "json",
					data: ({
						'number': new_num,
						'currDepot': curr_depot,
						'toDepot': to_depot,
						'goodsInfo': goods,
						'amount': sum,
						'operatorTime': create_time,
						'operator': operator,
						'remark': Remark
					}),
					success: function(data){
						if(data.code == 200){
							alert("发送成功");
						}
					},
					error: function(){
						alert("系统错误!");
					}
				});
			}
		</script>
	</head>

	<body>
		<div id="searchPanel" class="easyui-panel" style="padding:3px;" title="查询窗口" iconCls="icon-search" collapsible="true" closable="false">
			<table id="searchTable">
				<tr>
					<td>单据编号：</td>
					<td>
						<input type="text" name="searchNumber" id="searchNumber" style="width:100px;" />
					</td>
					<td>商品信息：</td>
					<td>
						<input type="text" name="searchMaterial" id="searchMaterial" placeholder="名称，型号" style="width:100px;" />
					</td>
					<td>单据日期：</td>
					<td>
						<input type="text" name="searchBeginTime" id="searchBeginTime" onClick="WdatePicker({dateFmt:'yyyy-MM-dd'})" class="txt Wdate" style="width:100px;" />
					
					</td>
					<td>-</td>
					<td>
						<input type="text" name="searchEndTime" id="searchEndTime" onClick="WdatePicker({dateFmt:'yyyy-MM-dd'})" class="txt Wdate" style="width:100px;" />
						
					</td>
					<td>&nbsp;</td>
					<td>
						<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search" id="searchBtn">查询</a>&nbsp;
						<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-redo" id="searchResetBtn">重置</a>
					</td>
				</tr>
			</table>
		</div>
		<!-- 数据显示table -->
		<div id="tablePanel" class="easyui-panel" style="padding:1px;top:300px;" title="调拨出库列表" iconCls="icon-list" collapsible="true" closable="false">
			<table id="tableData" style="top:300px;border-bottom-color:#FFFFFF"></table>
		</div>
		<!--单据详细-->
		<div id="depotHeadDlgShow" class="easyui-dialog" style="width:1200px;padding:10px 20px;top:70px" closed="true" buttons="#dlg-buttons-show" modal="true" cache="false" collapsible="false" closable="true">
			<table>
				<tr>
					<td style="width:60px;">单据日期：</td>
					<td style="padding:5px;width:130px;">
						<span id="OperTimeShow"></span>
					</td>
					<td style="width:70px;">单据编号：</td>
					<td style="padding:5px;width:130px;">
						<span id="NumberShow"></span>
					</td>
					<td style="width:80px;"></td>
					<td style="padding:5px;width:140px;"></td>
					<td style="width:70px;"></td>
					<td style="padding:5px;width:140px;"></td>
					<td style="width:100px;"></td>
				</tr>
				<tr>
					<td colspan="9" style="width: 1130px;">
						<!-- 商品列表table -->
						<table id="materialDataShow" style="top:100px;border-bottom-color:#FFFFFF"></table>
					</td>
				</tr>
				<tr>
					<td style="width:60px;">单据备注：</td>
					<td colspan="8" style="height:35px;">
						<span id="RemarkShow" style="width: 1070px; height:35px;"></span>
					</td>
				</tr>
			</table>
		</div>
		<div id="dlg-buttons-show">
			<a href="javascript:void(0)" id="printDepotHeadShow" class="easyui-linkbutton" iconCls="icon-ok">打印</a>
			<a href="javascript:void(0)" id="cancelDepotHeadShow" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#depotHeadDlgShow').dialog('close')">取消</a>
		</div>
		<!--添加单据列表-->
		<div id="depotHeadDlg" class="easyui-dialog" style="width:1200px;padding:10px 20px;top:60px" closed="true" buttons="#dlg-buttons" modal="true" cache="false" collapsible="false" closable="true">
			<form id="depotHeadFM" method="post" novalidate>
				<table>
					<tr>
						<td style="width:80px;">单据日期：</td>
						<td style="padding:5px;width:170px;">
							<input type="text" name="create_time" id="create_time" class="txt Wdate" style="width:140px;" readonly/>
						</td>
						<td style="width:80px;">单据编号：</td>
						<td style="padding:5px">
							<input  name="new_num" id="new_num" style="width:150px;" readonly/>
						</td>
						<td style="width:80px;">仓库编号：</td>
						<td style="padding:5px">
							<input name="curr_depot" id="curr_depot" class="easyui-combobox" style="width:150px;" />
						</td>
						<td style="width:80px;">目标仓库：</td>
						<td style="padding:5px">
							<input name="to_depot" id="to_depot" class="easyui-combobox" style="width:150px;" />
						</td>
						<td style="padding:5px;width:100px;"></td>
					</tr>
					<tr>
						<td colspan="9">
							<!-- 商品列表table -->
							<table id="materialData" style="top:100px;border-bottom-color:#FFFFFF"></table>
						</td>
					</tr>
					<tr>
						<td style="width:80px;">总数量：</td>
						<td style="padding:5px">
							<input name="sum" id="sum" class="easyui-numberbox" data-options="value:0" style="width:150px;" readonly/>
						</td>
						<td style="width:80px;">操作人：</td>
						<td style="padding:5px">
							<input name="operator" id="operator" style="width:150px;" readonly/>
						</td>
					</tr>
					<tr>
						<td colspan="9">
							<textarea name="Remark" id="Remark" rows="2" cols="2" placeholder="暂无备注信息" style="width: 1130px; height:35px;"></textarea>
						</td>
					</tr>
				</table>
			</form>
		</div>
		<div id="dlg-buttons">
			<a href="javascript:void(0)" id="saveAll" class="easyui-linkbutton" iconCls="icon-ok" onclick="sendSava()">保存</a>
			<a href="javascript:void(0)" id="cancelAll" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#depotHeadDlg').dialog('close')">取消</a>
		</div>
		<div id="addDlg" class="easyui-dialog" closed="true" buttons="#add-buttons" modal="true" cache="false" collapsible="false" closable="true">
			<form id="addFM">
				<table>
					<tr>
						<td>商品名</td>
						<td style="padding: 5px;">
							<input name="name" id="name" class="easyui-combobox" style="width: 230px; height: 20px;" />
							<input name="id" id="id" type="hidden" />
						</td>
					</tr>
					<tr>
						<td>当前仓库数量</td>
						<td style="padding: 5px;">
							<input name="curr_count" id="curr_count" class="easyui-numberbox" style="width: 230px; height: 20px;" readonly />
						</td>
					</tr>
					<tr>
						<td>目标仓库数量</td>
						<td style="padding: 5px;">
							<input name="tar_count" id="tar_count" class="easyui-numberbox" style="width: 230px; height: 20px;" readonly />
						</td>
					</tr>
					<tr>
						<td>调拨数量</td>
						<td style="padding: 5px;">
							<input name="to_count" id="to_count" class="easyui-numberbox" data-options="value:0" style="width: 230px; height: 20px;" />
						</td>

					</tr>
					<tr>
						<td>单位</td>
						<td style="padding: 5px;">
							<input name="unit" id="unit" class="easyui-validatebox" style="width: 230px; height: 20px;" readonly/>
						</td>
					</tr>
				</table>
			</form>
		</div>
		<div id="add-buttons">
			<a href="javascript:void(0)" id="addGoods" class="easyui-linkbutton" iconCls="icon-ok" onclick="addGoods()">保存</a>
			<a href="javascript:void(0)" id="cancelAddGoods" class="easyui-linkbutton" iconCls="icon-cancel" onclick="close_addFM()">取消</a>
		</div>
	</body>

</html>